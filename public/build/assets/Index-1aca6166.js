import{M as S}from"./HasModal-fa56130c.js";import{A as U}from"./AppLayout-40f8bbe7.js";import O from"./ModalEntryDetail-b6632307.js";import{B as q}from"./Button-03e0d3fd.js";import{B as F}from"./ButtonIcon-b1d1d2b0.js";import{a as L}from"./Dropdown-034da47d.js";import{B as I}from"./DropdownSearch-eb09b8b3.js";import{B as A}from"./Link-359d994c.js";import{B as D}from"./Table-6b0ddb68.js";import{B as V}from"./Tag-8100534e.js";import{_ as a,z as H,f as u,i as t,p as E,q as o,u as p,s as d,r as h,o as n,t as c,k as m,F as y,j as C,w as b,n as j}from"./vue-loading.min-a6a947f0.js";import{v as Q}from"./icon-class-4ab3933f.js";import{k as R}from"./utils-caa7a80b.js";import{_ as G}from"./_plugin-vue_export-helper-c27b6911.js";import"./Breadcrumbs-f0ae94d4.js";import"./NavbarItem-766600c9.js";import"./ModalCard-06597c5e.js";import"./Icon-6def3c13.js";import"./Field-a8082082.js";import"./Field-e1691255.js";import"./InputError-9b7084c8.js";import"./DropdownSearch-d54bf8fb.js";import"./Input-4c73d710.js";const J={name:"SystemLog",components:{BizButton:q,BizButtonIcon:F,BizDropdownItem:L,BizFormDropdownSearch:I,BizLink:A,BizTable:D,BizTag:V,ModalEntryDetail:O},mixins:[S],layout:U,props:{can:{type:Object,default:()=>{}},pageQueryParams:{type:Object,required:!0},tagAuth:{type:[Object,null],default:null}},data(){return{hasMoreEntries:!0,hasNewEntries:!1,lastEntryIndex:"",ready:!1,recordingStatus:"enabled",loadingMoreEntries:!1,loadingNewEntries:!1,autoLoadsNewEntries:!1,resource:"requests",basePath:"/telescope",entries:[],tag:"",entriesPerRequest:50,familyHash:"",newEntriesTimeout:null,newEntriesTimer:4e3,updateEntriesTimeout:null,updateEntriesTimer:4e3,selectedEntry:null,iconEye:Q,users:[],selectedUser:this.tagAuth??null}},watch:{selectedUser(e,i){a.isEmpty(e)?this.tag="":this.tag="Auth:"+e.id,this.$inertia.get(route("admin.system-log.index"),{tag:this.tag},{replace:!0,preserveState:!0,onStart:()=>{this.hasNewEntries=!1,this.lastEntryIndex="",clearTimeout(this.newEntriesTimeout)},onFinish:()=>{this.loadEntries(l=>{this.entries=l,this.checkForNewEntries(),this.ready=!0})}})}},mounted(){this.familyHash=this.pageQueryParams.family_hash||"",this.tag=this.pageQueryParams.tag||"",this.loadEntries(e=>{this.entries=e,this.checkForNewEntries(),this.ready=!0}),this.updateEntries(),this.loadUserOptions()},unmounted(){clearTimeout(this.newEntriesTimeout),clearTimeout(this.updateEntriesTimeout),document.onkeyup=null},methods:{truncate:a.truncate,requestPromise(e={},i=null){const l=this.basePath+"/telescope-api/"+this.resource,k={tag:this.tag,family_hash:this.familyHash};return axios.post(l,i,{params:{...k,...e}})},loadEntries(e){this.requestPromise({before:this.lastEntryIndex,take:this.entriesPerRequest}).then(i=>{this.lastEntryIndex=i.data.entries.length?a.last(i.data.entries).sequence:this.lastEntryIndex,this.hasMoreEntries=i.data.entries.length>=this.entriesPerRequest,this.recordingStatus=i.data.status,a.isFunction(e)&&e(i.data.entries)})},loadNewEntries(){this.hasMoreEntries=!0,this.hasNewEntries=!1,this.lastEntryIndex="",this.loadingNewEntries=!0,clearTimeout(this.newEntriesTimeout),this.loadEntries(e=>{this.entries=e,this.loadingNewEntries=!1,this.checkForNewEntries()})},loadOlderEntries(){this.loadingMoreEntries=!0,this.loadEntries(e=>{this.entries.push(...e),this.loadingMoreEntries=!1})},checkForNewEntries(){this.newEntriesTimeout=setTimeout(()=>{this.requestPromise({take:1}).then(e=>{this._isDestroyed||(this.recordingStatus=e.data.status,e.data.entries.length&&!this.entries.length?this.loadNewEntries():e.data.entries.length&&a.first(e.data.entries).id!==a.first(this.entries).id?this.autoLoadsNewEntries?this.loadNewEntries():this.hasNewEntries=!0:this.checkForNewEntries())})},this.newEntriesTimer)},updateEntries(){this.updateEntriesTimeout=setTimeout(()=>{let e=a.chain(this.entries).filter(i=>i.content.status==="pending").map("id").value();e.length&&axios.post(this.basePath+"/telescope-api/"+this.resource,{uuids:e}).then(i=>{this.recordingStatus=i.data.status,this.entries=a.map(this.entries,l=>a.includes(e,l.id)?a.find(i.data.entries,{id:l.id}):l)}),this.updateEntries()},this.updateEntriesTimer)},viewDetail(e){this.selectedEntry=e,this.openModal()},onCloseModal(){this.selectedEntry=null},loadUserOptions(e){axios.get(route("admin.system-log.search-users"),{params:{term:e}}).then(i=>{this.users=i.data})},searchUsers:a.debounce(function(e){this.loadUserOptions(e)},H),statusCodeColor:R}},K={class:"box"},W={class:"columns"},X={class:"column"},Y={style:{"min-width":"4rem"}},Z={class:"table-container"},$=t("thead",null,[t("tr",null,[t("th",null,"Verb"),t("th",null,"Path"),t("th",null,"Status"),t("th",null,"User"),t("th",null,"Happened At"),t("th",null,"Actions")])],-1),ee={key:0},te={colspan:"100",class:"has-text-centered"},se=t("span",null,"Load New Entries",-1),ie={key:1},ne={colspan:"100",class:"has-text-centered"},re=t("span",null,"Load More",-1);function oe(e,i,l,k,r,_){const N=h("biz-dropdown-item"),T=h("biz-form-dropdown-search"),M=h("biz-button"),f=h("biz-tag"),v=h("biz-link"),B=h("biz-button-icon"),x=h("biz-table"),P=h("modal-entry-detail");return n(),u("div",null,[t("div",K,[t("div",W,[t("div",X,[E(T,{"close-on-click":!0,"is-clearable":!0,onSearch:i[1]||(i[1]=s=>_.searchUsers(s))},{trigger:o(()=>{var s;return[t("span",Y,c(((s=r.selectedUser)==null?void 0:s.value)??"Select User"),1)]}),default:o(()=>[E(N,{onClick:i[0]||(i[0]=s=>r.selectedUser=null)},{default:o(()=>[m(" (None) ")]),_:1}),(n(!0),u(y,null,C(r.users,s=>(n(),p(N,{key:s.id,onClick:g=>r.selectedUser=s},{default:o(()=>[m(c(s.value),1)]),_:2},1032,["onClick"]))),128))]),_:1})])]),t("div",Z,[E(x,{class:"is-striped is-hoverable is-fullwidth"},{default:o(()=>[$,t("tbody",null,[r.hasNewEntries?(n(),u("tr",ee,[t("td",te,[r.loadingNewEntries?d("",!0):(n(),p(M,{key:0,class:"is-primary is-small",type:"button",onClick:b(_.loadNewEntries,["prevent"])},{default:o(()=>[se]),_:1},8,["onClick"])),r.loadingNewEntries?(n(),p(f,{key:1},{default:o(()=>[m(" Loading ... ")]),_:1})):d("",!0)])])):d("",!0),(n(!0),u(y,null,C(r.entries,s=>{var g,z;return n(),u("tr",{key:s.id},[t("th",null,[E(f,null,{default:o(()=>[m(c(s.content.method),1)]),_:2},1024)]),t("td",null,c(_.truncate(s.content.uri,{length:50})),1),t("td",null,[E(f,{class:j(_.statusCodeColor(s.content.response_status))},{default:o(()=>[m(c(s.content.response_status),1)]),_:2},1032,["class"])]),t("td",null,[(g=s.content)!=null&&g.user?(n(),u(y,{key:0},[l.can.user.edit?(n(),p(v,{key:0,href:e.route("admin.users.edit",s.content.user.id)},{default:o(()=>{var w;return[m(c(((w=s.content.user)==null?void 0:w.name)??""),1)]}),_:2},1032,["href"])):(n(),u(y,{key:1},[m(c(((z=s.content.user)==null?void 0:z.name)??""),1)],64))],64)):d("",!0)]),t("td",null,c(s.created_at),1),t("td",null,[E(B,{class:"is-ghost has-text-black ml-1","icon-class":"is-small",title:"View",type:"button",icon:r.iconEye,onClick:b(w=>_.viewDetail(s),["prevent"])},null,8,["icon","onClick"])])])}),128)),r.hasMoreEntries?(n(),u("tr",ie,[t("td",ne,[r.loadingMoreEntries?d("",!0):(n(),p(M,{key:0,class:"is-primary is-small",type:"button",onClick:b(_.loadOlderEntries,["prevent"])},{default:o(()=>[re]),_:1},8,["onClick"])),r.loadingMoreEntries?(n(),p(f,{key:1},{default:o(()=>[m(" Loading ... ")]),_:1})):d("",!0)])])):d("",!0)])]),_:1})])]),e.isModalOpen?(n(),p(P,{key:0,entry:r.selectedEntry,onCloseModal:e.closeModal,onOpenModal:e.openModal},null,8,["entry","onCloseModal","onOpenModal"])):d("",!0)])}const xe=G(J,[["render",oe]]);export{xe as default};
